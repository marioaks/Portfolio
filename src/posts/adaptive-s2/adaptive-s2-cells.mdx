---
name: "Adaptive S2 Cells"
description: Using an innovative S2 Cell covering to normalize regions by more unique methods than area and population.

title: "Adaptive S2 Cells"
subtitle: In this post I'll talk about an advanced geographic normalization technique I helped create. This technique makes use of Google's impressive S2 Cell library to generate new cell-based regions using discrete point-based data. An adaptive S2 covering allows for normalizing regions by more unique methods than area and population.

date: "November 2019"
order: 6
thumbnail: media/thumbnail.png

company: "Topos"
collaborators: 
- Eric Buth

categories:
  - algorithm-creation

embeddedImages:
  - media/thumbnail.png 
  - media/adaptive-s2-chicago.png 
  - media/adaptive-s2-nyc.png 
  - media/s2-cells.png

---

    <Img xxl {...props.embeddedImages.thumbnail}/>

    ### The Motivation

    When building [FIT](/fit), my coworkers and I were discussing how we could build a model that recommended georaphic locations for where a brand should open up a new store. Using a brand's previous locations, its site-selection patterns, and the patterns of the stores it often co-locates with, could we build a recommendation algorithm that recommended places with granularity?

    A first iteration of the algorithm involved counting up all of the points of interest in all the Census Block Groups in the US and generating a model using the CBGs as the classes. In other words, a recommendation algorithm that scored Census Block Groups for a brand based on the its brand composition. Gucci might be recommended CBGs with lots of high-end fashion and a local coffee shop might be recommended CBGs with lots of other local food options. 

    The main problem that we had with this initial version of the algorithm was that CBGs simply aren't a great geographic unit for these recommendations. The reason comes down to normalization. CBGs are designed to contain approximately 600 to 3,000 people â€” CBGs in rural areas tend to be larger than those in urban areas. While this means using CBGs as classes is better than using Zipcodes or Counties for example, when trying to score locations based on commercial activity, residential population density based regions don't really give us a good apples to apples comparisson between places. Though all CBGs have roughly the same population, they don't have roughly the same commercial activity. Therefore, the CBGs in our algorithm will not be scored perfectly. 

    ---

    ### A better solution


    Rather than using CBGs that partition the US by population density, what if we could partition the US ourselves based on commercial density. The idea Eric Buth and I came up with was one that utilized Google's S2 Cell library. 

    <Wrap>

      <Img {...props.embeddedImages.s2Cells}/>

      Google's S2 Cell library provides us with a technique to partition the earth's surface into a set of non-overlapping cells that all have approximately equal areas. The cells are generated by encasing the earth's sphere inside a cube and projecting each of the six sides of the cube onto the globe. Then, depending on how granular you want your cells to be, you can specify a level from 1 to 30 and recursively break down each cell into 4 different equal sized cells. S2 cells are a great technological innovation because they are a useful for making spacial indexes that speed up point level databases and for approximating regions as a collection of cells.

    </Wrap>

    Using S2 cells, we wanted to create our own regions to replace CBGs where each region should have the same approxmiate commercial density. Starting with the 6 base cells from the original cube encasing, we recursively iterated through the cells and broke each cell up into four if the number of commercial stores found in the cell was above a certain number X. When the recursive algorithm was finished running, we would get an s2 geospatial covering that guaranteed that each cell had fewer than X stores. Now, from the computed cells, we could remove all cells from the system that had fewer than Y stores in order to get rid of all areas that didn't really have any commercial activity. Now, since each S2 cell has it's own unique id, each cell could be treated as it's own region with a commercial density number between X and Y. Using these regions in a classification model like the one in FIT would then yield apples-to-apples comparisons and more accurate recommendations.

    <Img xxl {...props.embeddedImages.adaptiveS2Chicago} caption="Adaptive cell covering in Chicago"/>
    <Img xxl {...props.embeddedImages.adaptiveS2Nyc} caption="Adaptive cell covering in New York City"/>

    An adaptive S2 cell covering would also allow us to break down extremely dense commercial areas and be able to compute scores in an extremely granular fashion. We'd likely be able to differentiate between city blocks if the values of X and Y were set to be small enough. 

    ---

    ### Other Uses For Adaptive S2 Coverings

    This adaptive s2 cell covering algorithm can be used for all sorts of modeling exersizes where regions should be defined by discrete points. An example of this would be defining regions by mobile phone geolocation pings to generate regions normalized by daytime population rather than residential population that. This could be used to figure out the best place to put up a billboard for example. Instead, you could use this algorithm to generate geolocation predictions for photographs or social media posts. Computing regions with the same number of hospitals, schools, or subways in them may prove useful in a urban planning function.

    One reason for why this normalization technique might not be useful is if census data also needs to be taken into account. If, for example, you had zipcode-level data that you wanted to use in your model, that data would have to be disaggregated into the new cell regions that were created. While there are certainly way to do this, it definitely presents a very real challenge. 